<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Organizador de Viajes</title>
  <link rel="icon" type="image/png" href="../IMAGES/iconHD.png">

  <link rel="stylesheet" href="assets/styles/detalle.css">
  <link rel="stylesheet" href="assets/styles/global.css">
  <link rel="stylesheet" href="assets/styles/planner.css">
  <link rel="stylesheet" href="assets/styles/inventory.css">
  <link rel="stylesheet" href="assets/styles/checkList.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

</head>

<body>

  <div id="online-users-badge" class="online-badge">
    <span class="pulse-icon">‚óè</span>
    <span id="online-count">1</span> online
  </div>

  <div class="back-button" id="backToHome">‚Üê Volver a carpetas</div>

  <header class="hero-header">
    <div class="overlay">
      <h1>Planificador de Viaje</h1>
      <p id="current-folder-name" class="folder-name">Cargando carpeta...</p>
    </div>
  </header>

  <div class="tabs">
    <button class="tab-btn active" data-tab="planner">Itinerario</button>
    <button class="tab-btn" data-tab="inventory">Inventario</button>
    <button class="tab-btn" data-tab="checklist">Checklist</button>

    <button class="tab-btn" data-tab="details">Detalles del Viaje</button>
  </div>

  <section id="planner" class="tab-content active">
    <div class="planner-container">
      
      <div class="left-col-iti">
        <section id="calendar-section" class="card">
          <h2>Fechas del Viaje</h2>
          <div id="trip-calendar"></div>
          </section>
      </div>

      <div class="right-col-iti">
        <section id="itinerary-section" class="card">
          </section>
      </div>

    </div>

    <div id="activity-modal" class="modal hidden">
      <div class="modal-content">
        <h3 id="modal-title" class="mb-2">Agregar Actividad</h3>
        <div class="mb-2">
            <label class="mb-1 d-block">Hora:</label>
            <input type="time" id="activity-time" value="12:00">
        </div>
        <div class="mb-2">
            <label class="mb-1 d-block">Descripci√≥n:</label>
            <textarea id="activity-desc" rows="3" placeholder="Ej: Visita al museo..."></textarea>
        </div>
        <div class="modal-buttons">
          <button id="save-activity-btn" class="btn btn-primary">Guardar</button>
          <button id="cancel-activity-btn" class="btn btn-secondary">Cancelar</button>
        </div>
      </div>
    </div>
  </section>

  <section id="inventory" class="tab-content">
    <div id="app" class="inventory-container">
      
      <div id="budget-screen" class="modal hidden">
        <div class="modal-content text-center">
            <h2 id="budget-title" class="mb-2">Ingresa Presupuesto de Viaje</h2>
            <form id="budget-form">
              <div class="input-with-prefix mb-2">
                <span class="prefix">$</span>
                <input id="budget-input" type="number" min="0" step="1" value="1000" required />
              </div>
              <button type="submit" class="btn btn-primary full-width">Comenzar Planeaci√≥n</button>
            </form>
        </div>
      </div>

      <section class="mb-2">
        <div class="grid-3">
          <div class="card text-center">
            <div class="card-title-sm">Presupuesto Inicial üíº</div>
            <div class="card-content big-value" id="initial-budget">$0</div>
            <button id="edit-budget-btn" class="btn btn-secondary" style="margin-top: 10px; font-size: 0.8rem;">
                ‚úèÔ∏è Editar
            </button>
          </div>
          <div class="card text-center">
            <div class="card-title-sm">Total Gastado üõí</div>
            <div class="card-content big-value" id="total-spent">$0</div>
          </div>
          <div class="card text-center" id="remaining-card">
            <div class="card-title-sm">Restante üìâ</div>
            <div class="card-content big-value" id="remaining-budget">$0</div>
          </div>
        </div>
      </section>

      <div class="grid-main">
        
        <aside class="left-col">
          <div class="card mb-2">
            <div class="card-header">
              <div class="card-title">Agregar Item</div>
            </div>
            <form id="add-item-form">
              <div class="mb-2">
                  <label class="card-title-sm">Nombre</label>
                  <input id="item-name" type="text" placeholder="Ej: Carpa" required />
              </div>
              <div class="mb-2">
                  <label class="card-title-sm">Categor√≠a</label>
                  <select id="item-category" required>
                    <option value="">Seleccionar...</option>
                    <option value="Alojamiento">Alojamiento</option>
                    <option value="Transporte">Transporte</option>
                    <option value="Comida">Comida</option>
                    <option value="Entretenimiento">Entretenimiento</option>
                    <option value="Salud e Higiene">Salud e Higiene</option>
                    <option value="Ropa y Accesorios">Ropa y Accesorios</option>
                    <option value="Tecnolog√≠a">Tecnolog√≠a</option>
                    <option value="Documentos">Documentos</option>
                    <option value="Otros">Otros</option>
                  </select>
              </div>
              <div class="mb-2" style="display: flex; gap: 10px;">
                  <div style="flex:1">
                      <label class="card-title-sm">Costo</label>
                      <input id="item-cost" type="number" step="1" placeholder="0" min="0" />
                  </div>
                  <div style="flex:1">
                      <label class="card-title-sm">Cant.</label>
                      <input id="item-quantity" type="number" step="1" min="1" value="1" required />
                  </div>
              </div>
              <button type="submit" class="btn btn-accent full-width">
                ‚ûï Agregar
              </button>
            </form>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">Sugerencias</div>
            </div>
            <div id="suggestions" class="suggestions-grid"></div>
            <p class="card-title-sm" style="margin-top:10px; font-style:italic;">Haz clic para autocompletar.</p>
          </div>
        </aside>

        <section class="right-col">
          <div class="card full-height">
            <div class="card-header">
              <div class="card-title">Inventario de Viaje</div>
              <input type="text" id="search-input" placeholder="Buscar..." style="max-width: 200px;">
            </div>
            <div class="card-content scroll" id="items-container">
                </div>
          </div>
        </section>
      </div>
    </div>
  </section>

<section id="checklist" class="tab-content">
    <div class="wide-container">
        
        <div class="card full-height-card">
            <div class="checklist-header-row">
                <h2 class="checklist-title">Check List</h2>
                <span class="checklist-summary" id="progress-text-count">0 / 0 items</span>
            </div>
            
            <div class="progress-track-wrapper">
                <div class="progress-track">
                    <div id="progress-bar-fill" class="progress-fill"></div>
                </div>
            </div>

            <form id="add-checklist-form" class="checklist-toolbar">
                <div class="input-group">
                    <input type="text" id="check-name" placeholder="¬øQu√© necesitas llevar?" required autocomplete="off">
                </div>
                <div class="select-group">
                    <select id="check-category" required>
                        <option value="" disabled selected>Categor√≠a</option>
                        <option value="Ropa">Ropa</option>
                        <option value="Documentos">Documentos</option>
                        <option value="Electr√≥nica">Electr√≥nica</option>
                        <option value="Aseo">Aseo Personal</option>
                        <option value="Varios">Varios</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span>Ôºã</span> Agregar
                </button>
            </form>

            <div id="checklist-items-container" class="checklist-scroll-area">
                <p class="text-muted text-center mt-4">Cargando tu lista...</p>
            </div>
        </div>

    </div>
  </section>


  <section id="details" class="tab-content">
    <div class="details-container">
      
      <div class="card mb-2">
        <div class="card-header">
          <div class="card-title">Gestionar Viaje</div>
        </div>
        <div class="details-actions">
          <p class="text-muted mb-2">Acciones r√°pidas para tu carpeta.</p>
          <div class="buttons-row">
              <button id="details-invite-btn" class="btn btn-primary">
                  ‚ûï Invitar Usuario
              </button>
              <button id="details-download-btn" class="btn btn-accent">
                  üì• Descargar Excel
              </button>
              <button id="details-leave-btn" class="btn" style="background-color: #f59e0b; color: white; display: none;">
                  üèÉ Salir del Viaje
              </button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">Participantes</div>
        </div>
        <div id="participants-list" class="user-list">
          <p class="text-muted">Cargando usuarios...</p>
        </div>
      </div>

    </div>
  </section>

  <div id="invite-modal" class="modal hidden">
    <div class="modal-content">
      <h3 class="mb-2">Invitar Usuario</h3>
      <input type="email" id="invite-email" placeholder="ejemplo@correo.com" class="mb-2" required>
      <div class="modal-buttons">
        <button id="send-invite-btn" class="btn btn-primary">Invitar</button>
        <button id="close-invite-btn" class="btn btn-secondary">Cancelar</button>
      </div>
      <p id="invite-status" class="text-center mt-2"></p>
    </div>
  </div>

  <div id="checklist-delete-modal" class="modal hidden">
    <div class="modal-content">
      <h3 class="mb-2">Confirmar Eliminaci√≥n</h3>
      <p id="checklist-delete-msg" class="mb-2">¬øEst√°s seguro de eliminar este item?</p>
      
      <div class="modal-buttons">
        <button id="confirm-delete-check-btn" class="btn btn-primary" style="background-color: var(--destructive, #d9534f); border-color: var(--destructive, #d9534f);">
          Eliminar
        </button>
        <button id="cancel-delete-check-btn" class="btn btn-secondary">
          Cancelar
        </button>
      </div>
    </div>
  </div>

  <div id="delete-user-modal" class="modal hidden">
    <div class="modal-content">
      <h3 class="mb-2">Expulsar Colaborador</h3>
      <p id="delete-user-msg" class="mb-2 text-center" style="color: #cbd5e1;">
        ¬øEst√°s seguro?
      </p>
      
      <div class="modal-buttons">
        <button id="confirm-expel-btn" class="btn btn-primary" style="background-color: var(--destructive); border: 1px solid var(--destructive);">
          Expulsar
        </button>
        <button id="cancel-expel-btn" class="btn btn-secondary">
          Cancelar
        </button>
      </div>
    </div>
  </div>

  <div id="leave-modal" class="modal hidden">
    <div class="modal-content">
      <h3 class="mb-2" style="color: #f59e0b;">‚ö†Ô∏è Abandonar Viaje</h3>
      <p class="mb-2 text-center">
        ¬øEst√°s seguro que quieres salir de este grupo? <br>
        Tendr√°n que invitarte de nuevo para volver a entrar.
      </p>
      <div class="modal-buttons">
        <button id="confirm-leave-btn" class="btn" style="background-color: #f59e0b; color: white;">
          S√≠, Salir
        </button>
        <button id="cancel-leave-btn" class="btn btn-secondary">
          Cancelar
        </button>
      </div>
    </div>
  </div>


  <script type="module">
    import { initChecklist } from "./assets/scripts/checkList.js";

    document.addEventListener("DOMContentLoaded", () => {
        // Iniciar la l√≥gica del checklist
        initChecklist();
    });
  </script>

  <script src="assets/scripts/detalle.js" type="module"></script>

  <script>
    // Recuperar ID de Carpeta
    const params = new URLSearchParams(window.location.search);
    const folderId = params.get('id');
    if (!folderId) {
      alert("No se encontr√≥ la carpeta.");
      window.location.href = "../CARPETAS/carpetas.html";
    } else {
      window.folderId = folderId;
    }
  </script>

  <script type="module">
    import { db } from "../firebase.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // 1. IMPORTAR LA FUNCI√ìN (NUEVO)
    import { initPresence } from "./assets/scripts/activo.js";

    async function setRandomHeaderImage(folderName) {
      const header = document.querySelector(".hero-header");
      if (!header) return;
      // Usamos una imagen por defecto si falla la API
      const defaultImg = "https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?q=80&w=2021&auto=format&fit=crop";
      
      try {
          const apiUrl = `https://api.unsplash.com/search/photos?query=${encodeURIComponent(folderName)}&client_id=pQOas4zYY4iWrx2AcbDhu4SchgJSRqCTfelsWFNBW0k`;
          const res = await fetch(apiUrl);
          const data = await res.json();
          if (data.results.length > 0) {
            header.style.backgroundImage = `url('${data.results[0].urls.full}')`;
          } else {
            header.style.backgroundImage = `url('${defaultImg}')`;
          }
      } catch(e) {
          header.style.backgroundImage = `url('${defaultImg}')`;
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
          const folderNameEl = document.getElementById("current-folder-name");
          
          // 2. INICIAR EL CONTADOR DE USUARIOS (NUEVO)
          // Lo hacemos aqu√≠ para asegurarnos de que window.folderId ya existe
          if (window.folderId) {
              initPresence(); 
          }

          if (!window.folderId || !folderNameEl) return;
          try {
            const folderRef = doc(db, "carpetas", window.folderId);
            const folderSnap = await getDoc(folderRef);
            if (folderSnap.exists()) {
              const data = folderSnap.data();
              const folderName = data.name || "Sin nombre";
              folderNameEl.textContent = folderName; 
              setRandomHeaderImage(folderName);
            }
          } catch (error) {
            console.error("Error carpeta:", error);
          }
        });

    
  </script>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script src="assets/scripts/global.js" type="module"></script>
  <script src="assets/scripts/planner.js" type="module"></script>
  <script src="assets/scripts/inventory.js" type="module"></script>
  <script src="assets/scripts/dashboard.js" type="module"></script>
  <script src="assets/scripts/activo.js" type="module"></script>
  
  <script>
    document.getElementById("backToHome").addEventListener("click", () => {
      window.location.href = "../CARPETAS/carpetas.html";
    });
  </script>
</body>
</html>